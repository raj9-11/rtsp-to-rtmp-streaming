name: Build RTSP-to-RTMP Streaming App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1'  # Weekly build on Monday 2 AM

env:
  main_project_module: app
  app_name: RTMPStreamer
  
jobs:
  build:
    name: Build Android Streaming App
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout repository (MUST BE FIRST)
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    # Step 2: Set up environment variables
    - name: Set environment variables
      run: |
        echo "date_today=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
        echo "repository_name=$(echo '${{ github.repository }}' | awk -F '/' '{print $2}')" >> $GITHUB_ENV
        echo "build_number=${{ github.run_number }}" >> $GITHUB_ENV
      
    # Step 3: Set up Java WITHOUT caching initially
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    # Step 4: Install system dependencies
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip curl build-essential
        
    # Step 5: Setup FFmpeg
    - name: Setup FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3
      id: setup-ffmpeg
      with:
        ffmpeg-version: release
        architecture: 'x64'
        linking-type: static
        github-token: ${{ github.token }}
        
    # Step 6: Create project structure FIRST
    - name: Create Android project structure
      run: |
        # Create directory structure
        mkdir -p app/src/main/java/com/rtmpstreamer/{activities,services,receivers,utils}
        mkdir -p app/src/main/res/{layout,values,drawable,xml,mipmap-hdpi,mipmap-mdpi,mipmap-xhdpi,mipmap-xxhdpi,mipmap-xxxhdpi}
        mkdir -p app/src/main/assets
        mkdir -p app/src/main/jniLibs/{armeabi-v7a,arm64-v8a,x86,x86_64}
        mkdir -p app/src/test/java
        mkdir -p app/src/androidTest/java
        
        # Create settings.gradle FIRST (critical for caching)
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
                maven { url 'https://jitpack.io' }
            }
        }
        
        include ':app'
        rootProject.name = 'RTMPStreamer'
        EOF
        
        # Create gradle.properties
        cat > gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
        org.gradle.parallel=true
        org.gradle.caching=true
        org.gradle.configureondemand=true
        android.useAndroidX=true
        android.enableJetifier=true
        android.nonTransitiveRClass=false
        android.nonFinalResIds=false
        EOF
        
    # Step 7: Create Gradle build files
    - name: Create Gradle build files
      run: |
        # Root build.gradle
        cat > build.gradle << 'EOF'
        buildscript {
            ext.kotlin_version = '1.8.20'
            ext.android_gradle_version = '8.0.2'
            
            dependencies {
                classpath "com.android.tools.build:gradle:$android_gradle_version"
                classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
            }
        }
        
        plugins {
            id 'com.android.application' version '8.0.2' apply false
            id 'org.jetbrains.kotlin.android' version '1.8.20' apply false
        }
        
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF
        
        # App build.gradle
        cat > app/build.gradle << 'EOF'
        plugins {
            id 'com.android.application'
            id 'org.jetbrains.kotlin.android'
        }
        
        android {
            namespace 'com.rtmpstreamer'
            compileSdk 33
            
            defaultConfig {
                applicationId "com.rtmpstreamer"
                minSdk 23
                targetSdk 33
                versionCode Integer.parseInt(System.getenv("GITHUB_RUN_NUMBER") ?: "1")
                versionName "1.0.${versionCode}"
                testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
                
                ndk {
                    abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86', 'x86_64'
                }
                
                buildConfigField "String", "RTSP_DEFAULT_URL", '"rtsp://your-camera-ip:554/stream"'
                buildConfigField "String", "RTMP_DEFAULT_URL", '"rtmp://a.rtmp.youtube.com/live2/"'
            }
            
            buildTypes {
                debug {
                    debuggable true
                    applicationIdSuffix '.debug'
                    versionNameSuffix '-debug'
                    buildConfigField "Boolean", "DEBUG_MODE", "true"
                }
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                    buildConfigField "Boolean", "DEBUG_MODE", "false"
                    
                    // For unsigned release builds in CI
                    signingConfig null
                }
            }
            
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_1_8
                targetCompatibility JavaVersion.VERSION_1_8
            }
            
            kotlinOptions {
                jvmTarget = '1.8'
            }
            
            buildFeatures {
                buildConfig true
                viewBinding true
            }
            
            packagingOptions {
                pickFirst '**/libc++_shared.so'
                pickFirst '**/libjsc.so'
            }
        }
        
        dependencies {
            // Core Android dependencies
            implementation 'androidx.core:core-ktx:1.10.1'
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.9.0'
            implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
            implementation 'androidx.lifecycle:lifecycle-runtime-ktx:2.6.1'
            implementation 'androidx.activity:activity-ktx:1.7.2'
            
            // RTMP/RTSP streaming libraries
            implementation 'com.github.pedroSG94.rtmp-rtsp-stream-client-java:rtplibrary:2.1.7'
            implementation 'com.github.pedroSG94.rtmp-rtsp-stream-client-java:encoder:2.1.7'
            
            // FFmpeg for Android
            implementation 'com.arthenica:mobile-ffmpeg-full:4.4.LTS'
            
            // Background task management
            implementation 'androidx.work:work-runtime-ktx:2.8.1'
            implementation 'androidx.lifecycle:lifecycle-service:2.6.1'
            
            // Permissions handling
            implementation 'com.karumi:dexter:6.2.3'
            
            // Network and HTTP
            implementation 'com.squareup.okhttp3:okhttp:4.11.0'
            implementation 'com.squareup.okhttp3:logging-interceptor:4.11.0'
            
            // JSON parsing
            implementation 'com.google.code.gson:gson:2.10.1'
            
            // Logging
            implementation 'com.jakewharton.timber:timber:5.0.1'
            
            // Testing
            testImplementation 'junit:junit:4.13.2'
            testImplementation 'org.mockito:mockito-core:5.3.1'
            androidTestImplementation 'androidx.test.ext:junit:1.1.5'
            androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
            androidTestImplementation 'androidx.work:work-testing:2.8.1'
        }
        EOF
        
    # Step 8: Setup Gradle Wrapper
    - name: Setup Gradle Wrapper
      run: |
        # Download and setup Gradle wrapper
        gradle wrapper --gradle-version 8.0.2 --distribution-type all
        chmod +x ./gradlew
        
        # Verify wrapper
        ./gradlew --version
        
    # Step 9: NOW set up Java with caching (files exist now)
    - name: Enable Gradle caching
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    # Step 10: Setup Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        target: google_apis
        arch: x86_64
        
    # Step 11: Install Android components
    - name: Install Android SDK components
      run: |
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-33"
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2"
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;25.1.8937393"
        echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.1.8937393" >> $GITHUB_ENV
        
    # Step 12: Download FFmpeg libraries for Android
    - name: Download FFmpeg Android libraries
      run: |
        # Download mobile-ffmpeg AAR
        wget -q -O mobile-ffmpeg.aar "https://github.com/tanersener/mobile-ffmpeg/releases/download/v4.4.LTS/mobile-ffmpeg-full-4.4.LTS.aar"
        
        # Extract native libraries
        unzip -q mobile-ffmpeg.aar -d ffmpeg-temp
        
        # Copy to proper locations
        if [ -d "ffmpeg-temp/jni" ]; then
          cp -r ffmpeg-temp/jni/* app/src/main/jniLibs/ 2>/dev/null || true
        fi
        
        # Cleanup
        rm -rf mobile-ffmpeg.aar ffmpeg-temp
        
    # Step 13: Create Android source files
    - name: Create Android source files
      run: |
        # Create MainActivity.kt
        cat > app/src/main/java/com/rtmpstreamer/MainActivity.kt << 'EOF'
        package com.rtmpstreamer
        
        import android.Manifest
        import android.content.Intent
        import android.content.pm.PackageManager
        import android.os.Bundle
        import android.widget.Toast
        import androidx.activity.result.contract.ActivityResultContracts
        import androidx.appcompat.app.AppCompatActivity
        import androidx.core.content.ContextCompat
        import androidx.work.ExistingPeriodicWorkPolicy
        import androidx.work.PeriodicWorkRequestBuilder
        import androidx.work.WorkManager
        import com.rtmpstreamer.databinding.ActivityMainBinding
        import com.rtmpstreamer.services.StreamingService
        import com.rtmpstreamer.utils.StreamingWorker
        import timber.log.Timber
        import java.util.concurrent.TimeUnit
        
        class MainActivity : AppCompatActivity() {
            private lateinit var binding: ActivityMainBinding
            
            private val requiredPermissions = arrayOf(
                Manifest.permission.CAMERA,
                Manifest.permission.RECORD_AUDIO,
                Manifest.permission.INTERNET,
                Manifest.permission.WAKE_LOCK
            )
            
            private val requestPermissionLauncher = registerForActivityResult(
                ActivityResultContracts.RequestMultiplePermissions()
            ) { permissions ->
                val allGranted = permissions.entries.all { it.value }
                if (allGranted) {
                    Toast.makeText(this, "All permissions granted", Toast.LENGTH_SHORT).show()
                } else {
                    Toast.makeText(this, "Some permissions denied", Toast.LENGTH_LONG).show()
                }
            }
            
            override fun onCreate(savedInstanceState: Bundle?) {
                super.onCreate(savedInstanceState)
                
                // Initialize Timber for logging
                if (BuildConfig.DEBUG_MODE) {
                    Timber.plant(Timber.DebugTree())
                }
                
                binding = ActivityMainBinding.inflate(layoutInflater)
                setContentView(binding.root)
                
                setupViews()
                checkPermissions()
                setupScheduledStreaming()
            }
            
            private fun setupViews() {
                // Set default URLs
                binding.rtspInput.setText(BuildConfig.RTSP_DEFAULT_URL)
                binding.rtmpOutput.setText(BuildConfig.RTMP_DEFAULT_URL)
                
                binding.startButton.setOnClickListener { startStreaming() }
                binding.stopButton.setOnClickListener { stopStreaming() }
                binding.executeCommand.setOnClickListener { executeFFmpegCommand() }
            }
            
            private fun checkPermissions() {
                val missingPermissions = requiredPermissions.filter {
                    ContextCompat.checkSelfPermission(this, it) != PackageManager.PERMISSION_GRANTED
                }
                
                if (missingPermissions.isNotEmpty()) {
                    requestPermissionLauncher.launch(missingPermissions.toTypedArray())
                }
            }
            
            private fun startStreaming() {
                val rtspUrl = binding.rtspInput.text.toString().trim()
                val rtmpUrl = binding.rtmpOutput.text.toString().trim()
                
                if (rtspUrl.isEmpty() || rtmpUrl.isEmpty()) {
                    Toast.makeText(this, "Please enter both RTSP and RTMP URLs", Toast.LENGTH_LONG).show()
                    return
                }
                
                val intent = Intent(this, StreamingService::class.java).apply {
                    action = StreamingService.ACTION_START_STREAMING
                    putExtra("rtsp_url", rtspUrl)
                    putExtra("rtmp_url", rtmpUrl)
                }
                startForegroundService(intent)
                
                Toast.makeText(this, "Streaming started", Toast.LENGTH_SHORT).show()
            }
            
            private fun stopStreaming() {
                val intent = Intent(this, StreamingService::class.java).apply {
                    action = StreamingService.ACTION_STOP_STREAMING
                }
                startService(intent)
                
                Toast.makeText(this, "Streaming stopped", Toast.LENGTH_SHORT).show()
            }
            
            private fun executeFFmpegCommand() {
                val command = binding.ffmpegCommand.text.toString().trim()
                if (command.isNotEmpty()) {
                    // Execute custom FFmpeg command
                    Toast.makeText(this, "Executing: $command", Toast.LENGTH_SHORT).show()
                    Timber.d("Custom FFmpeg command: $command")
                }
            }
            
            private fun setupScheduledStreaming() {
                val workRequest = PeriodicWorkRequestBuilder<StreamingWorker>(12, TimeUnit.HOURS)
                    .setInitialDelay(1, TimeUnit.MINUTES)
                    .build()
                
                WorkManager.getInstance(this).enqueueUniquePeriodicWork(
                    "scheduled_streaming",
                    ExistingPeriodicWorkPolicy.REPLACE,
                    workRequest
                )
            }
        }
        EOF
        
        # Create basic service file
        mkdir -p app/src/main/java/com/rtmpstreamer/services
        cat > app/src/main/java/com/rtmpstreamer/services/StreamingService.kt << 'EOF'
        package com.rtmpstreamer.services
        
        import android.app.Service
        import android.content.Intent
        import android.os.IBinder
        import timber.log.Timber
        
        class StreamingService : Service() {
            companion object {
                const val ACTION_START_STREAMING = "START_STREAMING"
                const val ACTION_STOP_STREAMING = "STOP_STREAMING"
            }
            
            override fun onBind(intent: Intent?): IBinder? = null
            
            override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
                when (intent?.action) {
                    ACTION_START_STREAMING -> {
                        val rtspUrl = intent.getStringExtra("rtsp_url") ?: ""
                        val rtmpUrl = intent.getStringExtra("rtmp_url") ?: ""
                        Timber.d("Starting streaming: $rtspUrl -> $rtmpUrl")
                        // Implement streaming logic here
                    }
                    ACTION_STOP_STREAMING -> {
                        Timber.d("Stopping streaming")
                        // Implement stop logic here
                        stopSelf()
                    }
                }
                return START_STICKY
            }
        }
        EOF
        
        # Create worker class
        mkdir -p app/src/main/java/com/rtmpstreamer/utils
        cat > app/src/main/java/com/rtmpstreamer/utils/StreamingWorker.kt << 'EOF'
        package com.rtmpstreamer.utils
        
        import android.content.Context
        import androidx.work.Worker
        import androidx.work.WorkerParameters
        import timber.log.Timber
        
        class StreamingWorker(context: Context, params: WorkerParameters) : Worker(context, params) {
            override fun doWork(): Result {
                Timber.d("Scheduled streaming work executed")
                // Implement scheduled streaming logic (11h50m cycle)
                return Result.success()
            }
        }
        EOF
        
    # Step 14: Create Android resources
    - name: Create Android resources
      run: |
        # Create layout file with ViewBinding
        cat > app/src/main/res/layout/activity_main.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <ScrollView xmlns:android="http://schemas.android.com/apk/res/android"
            xmlns:app="http://schemas.android.com/apk/res/auto"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:padding="16dp">
            
            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="vertical">
                
                <TextView
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:text="RTSP to RTMP Streamer"
                    android:textSize="24sp"
                    android:textStyle="bold"
                    android:gravity="center"
                    android:layout_marginBottom="24dp" />
                
                <com.google.android.material.textfield.TextInputLayout
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:layout_marginBottom="16dp">
                    
                    <com.google.android.material.textfield.TextInputEditText
                        android:id="@+id/rtsp_input"
                        android:layout_width="match_parent"
                        android:layout_height="wrap_content"
                        android:hint="RTSP URL (e.g., rtsp://192.168.1.100:554/stream)"
                        android:inputType="textUri" />
                </com.google.android.material.textfield.TextInputLayout>
                
                <com.google.android.material.textfield.TextInputLayout
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:layout_marginBottom="24dp">
                    
                    <com.google.android.material.textfield.TextInputEditText
                        android:id="@+id/rtmp_output"
                        android:layout_width="match_parent"
                        android:layout_height="wrap_content"
                        android:hint="RTMP URL (e.g., rtmp://a.rtmp.youtube.com/live2/YOUR_KEY)"
                        android:inputType="textUri" />
                </com.google.android.material.textfield.TextInputLayout>
                
                <LinearLayout
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:orientation="horizontal"
                    android:layout_marginBottom="24dp">
                    
                    <com.google.android.material.button.MaterialButton
                        android:id="@+id/start_button"
                        android:layout_width="0dp"
                        android:layout_height="wrap_content"
                        android:layout_weight="1"
                        android:layout_marginEnd="8dp"
                        android:text="Start Streaming"
                        style="@style/Widget.Material3.Button" />
                    
                    <com.google.android.material.button.MaterialButton
                        android:id="@+id/stop_button"
                        android:layout_width="0dp"
                        android:layout_height="wrap_content"
                        android:layout_weight="1"
                        android:layout_marginStart="8dp"
                        android:text="Stop Streaming"
                        style="@style/Widget.Material3.Button.OutlinedButton" />
                </LinearLayout>
                
                <com.google.android.material.textfield.TextInputLayout
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:layout_marginBottom="16dp">
                    
                    <com.google.android.material.textfield.TextInputEditText
                        android:id="@+id/ffmpeg_command"
                        android:layout_width="match_parent"
                        android:layout_height="wrap_content"
                        android:hint="Custom FFmpeg Command"
                        android:inputType="textMultiLine"
                        android:minLines="2" />
                </com.google.android.material.textfield.TextInputLayout>
                
                <com.google.android.material.button.MaterialButton
                    android:id="@+id/execute_command"
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:text="Execute FFmpeg Command"
                    style="@style/Widget.Material3.Button.TonalButton" />
                    
            </LinearLayout>
        </ScrollView>
        EOF
        
        # Create strings.xml
        cat > app/src/main/res/values/strings.xml << 'EOF'
        <resources>
            <string name="app_name">RTMP Streamer</string>
            <string name="notification_channel_name">Streaming Service</string>
            <string name="notification_channel_description">Background streaming notifications</string>
            <string name="streaming_notification_title">RTSP to RTMP Streaming</string>
            <string name="streaming_notification_text">Streaming in progress...</string>
        </resources>
        EOF
        
        # Create colors.xml
        cat > app/src/main/res/values/colors.xml << 'EOF'
        <resources>
            <color name="purple_200">#FFBB86FC</color>
            <color name="purple_500">#FF6200EE</color>
            <color name="purple_700">#FF3700B3</color>
            <color name="teal_200">#FF03DAC5</color>
            <color name="teal_700">#FF018786</color>
            <color name="black">#FF000000</color>
            <color name="white">#FFFFFFFF</color>
        </resources>
        EOF
        
        # Create themes.xml
        cat > app/src/main/res/values/themes.xml << 'EOF'
        <resources>
            <style name="Theme.RTMPStreamer" parent="Theme.Material3.DayNight">
                <item name="colorPrimary">@color/purple_500</item>
                <item name="colorPrimaryVariant">@color/purple_700</item>
                <item name="colorOnPrimary">@color/white</item>
                <item name="colorSecondary">@color/teal_200</item>
                <item name="colorSecondaryVariant">@color/teal_700</item>
                <item name="colorOnSecondary">@color/black</item>
            </style>
        </resources>
        EOF
        
    # Step 15: Create AndroidManifest.xml
    - name: Create AndroidManifest.xml
      run: |
        cat > app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            xmlns:tools="http://schemas.android.com/tools">
            
            <!-- Network permissions -->
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            
            <!-- Media permissions -->
            <uses-permission android:name="android.permission.CAMERA" />
            <uses-permission android:name="android.permission.RECORD_AUDIO" />
            <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
            <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
            
            <!-- Background and boot permissions -->
            <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
            <uses-permission android:name="android.permission.WAKE_LOCK" />
            <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
            <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />
            
            <!-- Battery optimization -->
            <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />
            
            <application
                android:allowBackup="true"
                android:dataExtractionRules="@xml/data_extraction_rules"
                android:fullBackupContent="@xml/backup_rules"
                android:icon="@mipmap/ic_launcher"
                android:label="@string/app_name"
                android:theme="@style/Theme.RTMPStreamer"
                tools:targetApi="31">
                
                <activity
                    android:name=".MainActivity"
                    android:exported="true"
                    android:screenOrientation="portrait">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
                
                <service
                    android:name=".services.StreamingService"
                    android:enabled="true"
                    android:exported="false"
                    android:foregroundServiceType="mediaPlayback" />
                
                <receiver
                    android:name=".receivers.BootReceiver"
                    android:enabled="true"
                    android:exported="true">
                    <intent-filter android:priority="1000">
                        <action android:name="android.intent.action.BOOT_COMPLETED" />
                        <action android:name="android.intent.action.MY_PACKAGE_REPLACED" />
                        <action android:name="android.intent.action.PACKAGE_REPLACED" />
                        <data android:scheme="package" />
                    </intent-filter>
                </receiver>
                
            </application>
        </manifest>
        EOF
        
    # Step 16: Create XML resources
    - name: Create XML resources
      run: |
        # Create backup rules
        mkdir -p app/src/main/res/xml
        cat > app/src/main/res/xml/backup_rules.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <full-backup-content>
            <exclude domain="sharedpref" path="." />
        </full-backup-content>
        EOF
        
        cat > app/src/main/res/xml/data_extraction_rules.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <data-extraction-rules>
            <cloud-backup>
                <exclude domain="sharedpref" path="." />
            </cloud-backup>
            <device-transfer>
                <exclude domain="sharedpref" path="." />
            </device-transfer>
        </data-extraction-rules>
        EOF
        
    # Step 17: Create app icons (placeholder)
    - name: Create app icons
      run: |
        # Create basic launcher icons (you can replace with actual icons later)
        for density in hdpi mdpi xhdpi xxhdpi xxxhdpi; do
          mkdir -p app/src/main/res/mipmap-$density
          # Create a simple placeholder icon file
          echo "Placeholder icon for $density" > app/src/main/res/mipmap-$density/ic_launcher.png
        done
        
    # Step 18: Create ProGuard rules
    - name: Create ProGuard rules
      run: |
        cat > app/proguard-rules.pro << 'EOF'
        # Add project specific ProGuard rules here.
        
        # Keep FFmpeg classes
        -keep class com.arthenica.mobileffmpeg.** { *; }
        
        # Keep RTMP library classes
        -keep class com.pedro.** { *; }
        
        # Keep model classes
        -keepclassmembers class * {
            @com.google.gson.annotations.SerializedName <fields>;
        }
        
        # Keep native methods
        -keepclasseswithmembernames class * {
            native <methods>;
        }
        EOF
        
    # Step 19: Validate Gradle setup
    - name: Validate Gradle setup
      run: |
        ./gradlew tasks --all
        ./gradlew dependencies
        
    # Step 20: Run lint checks
    - name: Run lint checks
      run: ./gradlew lintDebug
      continue-on-error: true
      
    # Step 21: Run unit tests
    - name: Run unit tests
      run: ./gradlew testDebugUnitTest
      continue-on-error: true
      
    # Step 22: Build debug APK
    - name: Build debug APK
      run: |
        ./gradlew assembleDebug
        echo "Debug APK built successfully!"
        
    # Step 23: Build release APK (unsigned)
    - name: Build release APK
      run: |
        ./gradlew assembleRelease
        echo "Release APK built successfully!"
        
    # Step 24: Upload debug APK
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.date_today }}-${{ env.app_name }}-debug-v${{ env.build_number }}
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    # Step 25: Upload release APK
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.date_today }}-${{ env.app_name }}-release-v${{ env.build_number }}
        path: app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 90
        
    # Step 26: Generate build report
    - name: Generate build report
      run: |
        echo "# üéâ Build Summary" > build-report.md
        echo "" >> build-report.md
        echo "**Build Date**: ${{ env.date_today }}" >> build-report.md
        echo "**Build Number**: ${{ env.build_number }}" >> build-report.md
        echo "**Repository**: ${{ github.repository }}" >> build-report.md
        echo "**Branch**: ${{ github.ref_name }}" >> build-report.md
        echo "**Commit**: ${{ github.sha }}" >> build-report.md
        echo "" >> build-report.md
        echo "## üì¶ Generated APKs" >> build-report.md
        echo "" >> build-report.md
        
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          DEBUG_SIZE=$(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          echo "- **Debug APK**: ‚úÖ Built successfully ($DEBUG_SIZE)" >> build-report.md
        fi
        
        if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          RELEASE_SIZE=$(du -h app/build/outputs/apk/release/app-release-unsigned.apk | cut -f1)
          echo "- **Release APK**: ‚úÖ Built successfully ($RELEASE_SIZE)" >> build-report.md
        fi
        
        echo "" >> build-report.md
        echo "## üîß Build Environment" >> build-report.md
        echo "" >> build-report.md
        echo "- **FFmpeg Version**: ${{ steps.setup-ffmpeg.outputs.ffmpeg-version }}" >> build-report.md
        echo "- **Java Version**: 17" >> build-report.md
        echo "- **Gradle Version**: 8.0.2" >> build-report.md
        echo "- **Android Gradle Plugin**: 8.0.2" >> build-report.md
        echo "- **Android SDK**: 33" >> build-report.md
        echo "- **NDK**: 25.1.8937393" >> build-report.md
        
        cat build-report.md
        
    # Step 27: Upload build report
    - name: Upload build report
      uses: actions/upload-artifact@v4
      with:
        name: build-report-${{ env.date_today }}
        path: build-report.md
        retention-days: 30
        
    # Step 28: Success notification
    - name: Build success notification
      run: |
        echo "üéâ RTSP-to-RTMP Streaming App built successfully!"
        echo "üì± Debug APK: Ready for testing"
        echo "üöÄ Release APK: Ready for production"
        echo "üìä Build artifacts uploaded to Actions tab"
        echo "‚è∞ Build completed in $(date)"
